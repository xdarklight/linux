# SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)
%YAML 1.2
---
$id: http://devicetree.org/schemas/mtd/mediatek,nfc.yaml#
$schema: http://devicetree.org/meta-schemas/core.yaml#

title: Mediatek NAND Flash Controller

maintainers:
  - Weijie Gao <weijie.gao@mediatek.com>
  - Jorge Ramirez-Ortiz <jorge.ramirez-ortiz@linaro.org>

properties:
  compatible:
    enum:
      - mediatek,mt2701-nfc
      - mediatek,mt2712-nfc
      - mediatek,mt7621-nfc
      - mediatek,mt7622-nfc

  reg:
    maxItems: 1

  clocks:
    minItems: 1
    maxItems: 2

  clock-names:
    minItems: 1
    maxItems: 2
    items:
      - const: nfi_clk
      - const: pad_clk

  interrupts:
    maxItems: 1

  ecc-engine: true
  "#address-cells": true
  "#size-cells": true

patternProperties:
  "^nand@[a-f0-9]$":
    type: object
    properties:
      nand-ecc-strength:
        description: |+
          The strength should be calculated as follows:
          E = (S - F) * 8 / B
          S = O / (P / Q)
            E : nand-ecc-strength.
            S : spare size per sector.
            F : FDM size, should be in the range [1,8].
                It is used to store free oob data.
            O : oob size.
            P : page size.
            Q : nand-ecc-step-size.
            B : number of parity bits needed to correct 1 bitflip.
                According to MTK NAND controller design, this number
                depends on max ecc step size that MTK NAND controller
                supports.
                If max ecc step size supported is 1024, then it
                should be always 14. And if max ecc step size is 512,
                then it should be always 13.
                If the result does not match any one of the listed
                choices below, please select the smaller valid value
                from the list.
                (otherwise the driver will do the adjustment at runtime)

      nand-ecc-step-size:
        description: |+
          1024 is recommended for large page NANDs.

allOf:
  - $ref: "nand-controller.yaml#"

  - if:
      properties:
        compatible:
          contains:
            enum:
              - mediatek,mt2701-nfc
              - mediatek,mt2712-nfc
              - mediatek,mt7622-nfc
    then:
      required:
        - interrupts

  - if:
      properties:
        compatible:
          contains:
            const: mediatek,mt2701-nfc
    then:
      patternProperties:
        "^nand@[a-f0-9]$":
          properties:
            nand-ecc-step-size:
              enum:
                - 512
                - 1024
            nand-ecc-strength:
              enum:
                - 4
                - 6
                - 8
                - 10
                - 12
                - 14
                - 16
                - 18
                - 20
                - 22
                - 24
                - 28
                - 32
                - 36
                - 40
                - 44
                - 48
                - 52
                - 56
                - 60

  - if:
      properties:
        compatible:
          contains:
            const: mediatek,mt2712-nfc
    then:
      patternProperties:
        "^nand@[a-f0-9]$":
          properties:
            nand-ecc-step-size:
              enum:
                - 512
                - 1024
            nand-ecc-strength:
              enum:
                - 4
                - 6
                - 8
                - 10
                - 12
                - 14
                - 16
                - 18
                - 20
                - 22
                - 24
                - 28
                - 32
                - 36
                - 40
                - 44
                - 48
                - 52
                - 56
                - 60
                - 68
                - 72
                - 80

  - if:
      properties:
        compatible:
          contains:
            const: mediatek,mt7621-nfc
    then:
      patternProperties:
        "^nand@[a-f0-9]$":
          properties:
            nand-ecc-step-size:
              const: 512
            nand-ecc-strength:
              enum:
                - 4
                - 6
                - 8
                - 10
                - 12

  - if:
      properties:
        compatible:
          contains:
            const: mediatek,mt7622-nfc
    then:
      patternProperties:
        "^nand@[a-f0-9]$":
          properties:
            nand-ecc-step-size:
              const: 512
            nand-ecc-strength:
              enum:
                - 4
                - 6
                - 8
                - 10
                - 12
                - 14
                - 16

required:
  - compatible
  - reg
  - clocks
  - clock-names
  - ecc-engine

additionalProperties: false

examples:
  - |
    nand-controller@1100d000 {
      compatible = "mediatek,mt2701-nfc";
      reg = <0x1100d000 0x1000>;
      interrupts = <56>;
      clocks = <&nfi_clk>, <&nfi_pad_clk>;
      clock-names = "nfi_clk", "pad_clk";
      ecc-engine = <&mtk_nfi_ecc>;
      #address-cells = <1>;
      #size-cells = <0>;
    };
  - |
    nand-controller@1e003000 {
      compatible = "mediatek,mt7621-nfc";
      reg = <0x1e003000 0x800>;
      clocks = <&nficlock>;
      clock-names = "nfi_clk";
      ecc-engine = <&mtk_nfi_ecc>;
      #address-cells = <1>;
      #size-cells = <0>;
    };
...
