/*
 * Copyright (c) 2017 Martin Blumenstingl <martin.blumenstingl@googlemail.com>.
 *
 * SPDX-License-Identifier: (GPL-2.0+ OR MIT)
 */

/dts-v1/;

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>

#include "meson8b.dtsi"

/ {
	model = "Endless Computers Endless Mini";
	compatible = "endless,ec-100", "amlogic,meson8b";

	aliases {
		serial0 = &uart_AO;
		serial1 = &uart_B;
	};

	cpus {
		cpu@200 {
			cpu-supply = <&vcck>;
		};

		cpu@201 {
			cpu-supply = <&vcck>;
		};

		cpu@202 {
			cpu-supply = <&vcck>;
		};

		cpu@203 {
			cpu-supply = <&vcck>;
		};
	};

	memory {
		reg = <0x40000000 0x40000000>;
	};

	gpio-keys-polled {
		compatible = "gpio-keys-polled";
		#address-cells = <1>;
		#size-cells = <0>;
		poll-interval = <100>;

		pal-switch {
			label = "pal";
			linux,input-type = <EV_SW>;
			linux,code = <KEY_SWITCHVIDEOMODE>;
			gpios = <&gpio GPIOH_7 GPIO_ACTIVE_LOW>;
		};

		ntsc-switch {
			label = "ntsc";
			linux,input-type = <EV_SW>;
			linux,code = <KEY_SWITCHVIDEOMODE>;
			gpios = <&gpio GPIOH_8 GPIO_ACTIVE_HIGH>;
		};

		power-button {
			label = "power";
			linux,code = <KEY_POWER>;
			gpios = <&gpio GPIOH_9 GPIO_ACTIVE_LOW>;
		};
	};

	gpio-poweroff {
		compatible = "gpio-poweroff";
		gpios = <&gpio_ao GPIOAO_2 GPIO_ACTIVE_LOW>;
	};

	iio-hwmon {
		compatible = "iio-hwmon";
		io-channels = <&saradc 8>;
	};

	leds {
		compatible = "gpio-leds";

		red-breathing {
			label = "ec-100:red:breathing";
			gpios = <&gpio_ao GPIOAO_7 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};
	};

	usb_vbus: regulator-usb-vbus {
		compatible = "regulator-fixed";

		regulator-name = "USB_VBUS";

		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		gpio = <&gpio_ao GPIOAO_5 GPIO_ACTIVE_HIGH>;
		enable-active-high;
	};

	vcck: regulator-vcck {
		compatible = "pwm-regulator";
		pwms = <&pwm_cd 1 1166 0>;
		regulator-min-microvolt = <860000>;
		regulator-max-microvolt = <1140000>;
		regulator-name = "VCCK";
		pwm-dutycycle-range = <100 0>;
		regulator-always-on;
	};

	vcc_1v8: regulator-vcc1v8 {
		compatible = "regulator-fixed";
		regulator-name = "VCC1V8";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;
	};
};

&ethmac {
	status = "okay";
/*
	TODO:
	pinctrl-0 = <&eth_pins>;
	pinctrl-names = "default";
*/

	phy-handle = <&eth_phy0>;
	phy-mode = "rmii";

	snps,reset-gpio = <&gpio GPIOH_4 0>;
	snps,reset-delays-us = <0 10000 1000000>;
	snps,reset-active-low;

	mdio {
		compatible = "snps,dwmac-mdio";
		#address-cells = <1>;
		#size-cells = <0>;

		eth_phy0: ethernet-phy@0 {
			/* IC Plus IP101A/G (0x02430c54) */
			reg = <0>;
		};
	};
};

&i2c_A {
	status = "okay";
	pinctrl-0 = <&i2c_a_pins>;
	pinctrl-names = "default";

	codec@1c {
		compatible = "realtek,rt5640";
		reg = <0x1c>;
		interrupt-parent = <&gpio_intc>;
		interrupts = <13 IRQ_TYPE_EDGE_BOTH>; /* GPIOAO_13 */
	};
};

&ir_receiver {
	status = "okay";
	pinctrl-0 = <&ir_recv_pins>;
	pinctrl-names = "default";
};

&saradc {
	status = "okay";
	vref-supply = <&vcc_1v8>;
};

&pwm_cd {
	status = "okay";
	pinctrl-0 = <&pwm_d_pins>;
	pinctrl-names = "default";
	clocks = <&clkc CLKID_XTAL>;
	clock-names = "clkin1";
};

/* exposed through the pin headers on the top of the PCB */
&uart_AO {
	status = "okay";
	pinctrl-0 = <&uart_ao_a_pins>;
	pinctrl-names = "default";
};

&uart_B {
	status = "okay";
	pinctrl-0 = <&uart_b0_pins>, <&uart_b0_cts_rts_pins>;
	pinctrl-names = "default";
	uart-has-rtscts;

	bluetooth {
		compatible = "realtek,rtl8723bs-bluetooth";
		enable-gpios = <&gpio GPIOX_20 GPIO_ACTIVE_HIGH>;
		reset-gpios = <&gpio GPIOX_11 GPIO_ACTIVE_HIGH>;
		realtek,config-data = /bits/ 8 <
			0x55 0xab 0x23 0x87 0x31 0x00 0xf4 0x00 0x08 0x01 0x00 0x00
			0x00 0x05 0x50 0x00 0x00 0x0c 0x00 0x10 0x02 0x80 0x92 0x04
			0x50 0xc5 0xea 0x19 0xe1 0x1b 0xf1 0xaf 0x5f 0x01 0xa4 0x0b
			0x27 0x00 0x01 0x63 0xfe 0x00 0x01 0x01 0x5b 0x01 0x04 0x0b
			0x0b 0x0b 0x0a 0xe3 0x01 0x01 0x00
		>;
	};
};

&usb1 {
	status = "okay";
};

&usb1_phy {
	status = "okay";
	phy-supply = <&usb_vbus>;
};
